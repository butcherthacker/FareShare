import { useNavigate, useLocation } from "react-router-dom";
import { useState, useRef, useEffect } from "react";
import { useAuth } from "../hooks/useAuth";
import { motion, AnimatePresence } from "framer-motion";
import { Settings, LogOut, Car, Search, BarChart3, Shield } from "lucide-react";

const Header: React.FC = () => {
    const navigate = useNavigate();
    const location = useLocation();
    const { isAuthenticated, user, logout } = useAuth();
    const [showDropdown, setShowDropdown] = useState(false);
    const dropdownRef = useRef<HTMLDivElement>(null);

    const isActive = (path: string) => location.pathname === path;

    /**
     * Close dropdown when clicking outside
     */
    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
                setShowDropdown(false);
            }
        }

        if (showDropdown) {
            document.addEventListener("mousedown", handleClickOutside);
        }

        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [showDropdown]);

    /**
     * Handle logout
     */
    const handleLogout = () => {
        logout();
        setShowDropdown(false);
        navigate("/");
    };

    /**
     * Get user initials for avatar
     */
    const getUserInitials = () => {
        if (!user?.full_name) return "U";
        const names = user.full_name.split(" ");
        if (names.length >= 2) {
            return `${names[0][0]}${names[names.length - 1][0]}`.toUpperCase();
        }
        return user.full_name.substring(0, 2).toUpperCase();
    };

    return (
        <header className="w-full border-b" style={{ backgroundColor: 'rgba(254, 248, 242, 0.6)', borderBottomColor: 'var(--color-secondary)', backdropFilter: 'blur(8px)', position: 'relative', zIndex: 1000 }}>
            <div className="max-w-[1200px] mx-auto px-6 py-3 flex items-center justify-between">
                {/* Logo - clickable to go to landing page */}
                <div
                    onClick={() => navigate("/")}
                    className="cursor-pointer flex items-center h-16 transition-opacity hover:opacity-80"
                >
                    <svg width="175" height="73" viewBox="0 0 324 135" fill="none" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto" style={{ filter: 'drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.3))' }}>
                        <path d="M20.652 89.512C19.3293 89.512 18.284 89.1493 17.516 88.424C16.7907 87.656 16.428 86.568 16.428 85.16V48.232C16.428 46.824 16.7907 45.7573 17.516 45.032C18.284 44.264 19.372 43.88 20.78 43.88H43.116C44.2253 43.88 45.0573 44.1573 45.612 44.712C46.1667 45.2667 46.444 46.056 46.444 47.08C46.444 48.1467 46.1667 48.9787 45.612 49.576C45.0573 50.1307 44.2253 50.408 43.116 50.408H24.62V63.144H41.772C42.8387 63.144 43.6493 63.4213 44.204 63.976C44.8013 64.5307 45.1 65.32 45.1 66.344C45.1 67.4107 44.8013 68.2427 44.204 68.84C43.6493 69.3947 42.8387 69.672 41.772 69.672H24.62V85.16C24.62 88.0613 23.2973 89.512 20.652 89.512ZM60.6515 89.64C58.3902 89.64 56.3635 89.2133 54.5715 88.36C52.8222 87.464 51.4355 86.2693 50.4115 84.776C49.4302 83.2827 48.9395 81.5973 48.9395 79.72C48.9395 77.416 49.5368 75.6027 50.7315 74.28C51.9262 72.9147 53.8675 71.9333 56.5555 71.336C59.2435 70.7387 62.8488 70.44 67.3715 70.44H70.5715V75.048H67.4355C64.7902 75.048 62.6782 75.176 61.0995 75.432C59.5208 75.688 58.3902 76.136 57.7075 76.776C57.0675 77.3733 56.7475 78.2267 56.7475 79.336C56.7475 80.744 57.2382 81.896 58.2195 82.792C59.2008 83.688 60.5662 84.136 62.3155 84.136C63.7235 84.136 64.9608 83.816 66.0275 83.176C67.1368 82.4933 68.0115 81.576 68.6515 80.424C69.2915 79.272 69.6115 77.9493 69.6115 76.456V69.096C69.6115 66.9627 69.1422 65.4267 68.2035 64.488C67.2648 63.5493 65.6862 63.08 63.4675 63.08C62.2302 63.08 60.8862 63.2293 59.4355 63.528C58.0275 63.8267 56.5342 64.3387 54.9555 65.064C54.1448 65.448 53.4195 65.5547 52.7795 65.384C52.1822 65.2133 51.7128 64.872 51.3715 64.36C51.0302 63.8053 50.8595 63.208 50.8595 62.568C50.8595 61.928 51.0302 61.3093 51.3715 60.712C51.7128 60.072 52.2888 59.6027 53.0995 59.304C55.0622 58.4933 56.9395 57.9173 58.7315 57.576C60.5662 57.2347 62.2302 57.064 63.7235 57.064C66.7955 57.064 69.3128 57.5333 71.2755 58.472C73.2808 59.4107 74.7742 60.84 75.7555 62.76C76.7368 64.6373 77.2275 67.0693 77.2275 70.056V85.416C77.2275 86.7387 76.9075 87.7627 76.2675 88.488C75.6275 89.1707 74.7102 89.512 73.5155 89.512C72.3208 89.512 71.3822 89.1707 70.6995 88.488C70.0595 87.7627 69.7395 86.7387 69.7395 85.416V82.344H70.2515C69.9528 83.8373 69.3555 85.1387 68.4595 86.248C67.6062 87.3147 66.5182 88.1467 65.1955 88.744C63.8728 89.3413 62.3582 89.64 60.6515 89.64ZM89.4435 89.512C88.1208 89.512 87.0968 89.1707 86.3715 88.488C85.6888 87.7627 85.3475 86.7387 85.3475 85.416V61.224C85.3475 59.9013 85.6888 58.8987 86.3715 58.216C87.0542 57.5333 88.0142 57.192 89.2515 57.192C90.4888 57.192 91.4488 57.5333 92.1315 58.216C92.8142 58.8987 93.1555 59.9013 93.1555 61.224V65.256H92.5155C93.1128 62.696 94.2862 60.7547 96.0355 59.432C97.7848 58.1093 100.11 57.32 103.012 57.064C103.908 56.9787 104.612 57.2133 105.124 57.768C105.678 58.28 105.998 59.0907 106.084 60.2C106.169 61.2667 105.913 62.1413 105.316 62.824C104.761 63.464 103.908 63.848 102.756 63.976L101.348 64.104C98.7448 64.36 96.7822 65.1707 95.4595 66.536C94.1368 67.8587 93.4755 69.736 93.4755 72.168V85.416C93.4755 86.7387 93.1342 87.7627 92.4515 88.488C91.7688 89.1707 90.7662 89.512 89.4435 89.512ZM125.334 89.64C121.793 89.64 118.742 88.9787 116.182 87.656C113.622 86.3333 111.638 84.456 110.23 82.024C108.865 79.592 108.182 76.712 108.182 73.384C108.182 70.1413 108.843 67.304 110.166 64.872C111.531 62.44 113.387 60.5413 115.734 59.176C118.123 57.768 120.833 57.064 123.862 57.064C126.081 57.064 128.065 57.4267 129.814 58.152C131.606 58.8773 133.121 59.9227 134.358 61.288C135.638 62.6533 136.598 64.3173 137.238 66.28C137.921 68.2 138.262 70.376 138.262 72.808C138.262 73.576 137.985 74.1733 137.43 74.6C136.918 74.984 136.171 75.176 135.19 75.176H114.646V70.568H132.63L131.606 71.528C131.606 69.5653 131.307 67.9227 130.71 66.6C130.155 65.2773 129.323 64.2747 128.214 63.592C127.147 62.8667 125.803 62.504 124.182 62.504C122.39 62.504 120.854 62.9307 119.574 63.784C118.337 64.5947 117.377 65.768 116.694 67.304C116.054 68.7973 115.734 70.5893 115.734 72.68V73.128C115.734 76.6267 116.545 79.2507 118.166 81C119.83 82.7067 122.262 83.56 125.462 83.56C126.571 83.56 127.809 83.432 129.174 83.176C130.582 82.8773 131.905 82.3867 133.142 81.704C134.038 81.192 134.827 80.9787 135.51 81.064C136.193 81.1067 136.726 81.3413 137.11 81.768C137.537 82.1947 137.793 82.728 137.878 83.368C137.963 83.9653 137.835 84.584 137.494 85.224C137.195 85.864 136.662 86.4187 135.894 86.888C134.401 87.8267 132.673 88.5307 130.71 89C128.79 89.4267 126.998 89.64 125.334 89.64ZM188.941 89.512C187.661 89.512 186.679 89.1707 185.997 88.488C185.314 87.7627 184.973 86.7387 184.973 85.416V47.4C184.973 46.0773 185.314 45.0747 185.997 44.392C186.679 43.7093 187.661 43.368 188.941 43.368C190.221 43.368 191.202 43.7093 191.885 44.392C192.61 45.0747 192.973 46.0773 192.973 47.4V63.976H192.077C193.015 61.7147 194.466 60.008 196.429 58.856C198.434 57.6613 200.695 57.064 203.213 57.064C205.73 57.064 207.799 57.5333 209.421 58.472C211.042 59.4107 212.258 60.84 213.069 62.76C213.879 64.6373 214.285 67.0267 214.285 69.928V85.416C214.285 86.7387 213.943 87.7627 213.261 88.488C212.578 89.1707 211.597 89.512 210.317 89.512C209.037 89.512 208.034 89.1707 207.309 88.488C206.626 87.7627 206.285 86.7387 206.285 85.416V70.312C206.285 67.88 205.815 66.1093 204.877 65C203.981 63.8907 202.573 63.336 200.653 63.336C198.306 63.336 196.429 64.0827 195.021 65.576C193.655 67.0267 192.973 68.968 192.973 71.4V85.416C192.973 88.1467 191.629 89.512 188.941 89.512ZM232.714 89.64C230.453 89.64 228.426 89.2133 226.634 88.36C224.885 87.464 223.498 86.2693 222.474 84.776C221.493 83.2827 221.002 81.5973 221.002 79.72C221.002 77.416 221.599 75.6027 222.794 74.28C223.989 72.9147 225.93 71.9333 228.618 71.336C231.306 70.7387 234.911 70.44 239.434 70.44H242.634V75.048H239.498C236.853 75.048 234.741 75.176 233.162 75.432C231.583 75.688 230.453 76.136 229.77 76.776C229.13 77.3733 228.81 78.2267 228.81 79.336C228.81 80.744 229.301 81.896 230.282 82.792C231.263 83.688 232.629 84.136 234.378 84.136C235.786 84.136 237.023 83.816 238.09 83.176C239.199 82.4933 240.074 81.576 240.714 80.424C241.354 79.272 241.674 77.9493 241.674 76.456V69.096C241.674 66.9627 241.205 65.4267 240.266 64.488C239.327 63.5493 237.749 63.08 235.53 63.08C234.293 63.08 232.949 63.2293 231.498 63.528C230.09 63.8267 228.597 64.3387 227.018 65.064C226.207 65.448 225.482 65.5547 224.842 65.384C224.245 65.2133 223.775 64.872 223.434 64.36C223.093 63.8053 222.922 63.208 222.922 62.568C222.922 61.928 223.093 61.3093 223.434 60.712C223.775 60.072 224.351 59.6027 225.162 59.304C227.125 58.4933 229.002 57.9173 230.794 57.576C232.629 57.2347 234.293 57.064 235.786 57.064C238.858 57.064 241.375 57.5333 243.338 58.472C245.343 59.4107 246.837 60.84 247.818 62.76C248.799 64.6373 249.29 67.0693 249.29 70.056V85.416C249.29 86.7387 248.97 87.7627 248.33 88.488C247.69 89.1707 246.773 89.512 245.578 89.512C244.383 89.512 243.445 89.1707 242.762 88.488C242.122 87.7627 241.802 86.7387 241.802 85.416V82.344H242.314C242.015 83.8373 241.418 85.1387 240.522 86.248C239.669 87.3147 238.581 88.1467 237.258 88.744C235.935 89.3413 234.421 89.64 232.714 89.64ZM261.506 89.512C260.183 89.512 259.159 89.1707 258.434 88.488C257.751 87.7627 257.41 86.7387 257.41 85.416V61.224C257.41 59.9013 257.751 58.8987 258.434 58.216C259.117 57.5333 260.077 57.192 261.314 57.192C262.551 57.192 263.511 57.5333 264.194 58.216C264.877 58.8987 265.218 59.9013 265.218 61.224V65.256H264.578C265.175 62.696 266.349 60.7547 268.098 59.432C269.847 58.1093 272.173 57.32 275.074 57.064C275.97 56.9787 276.674 57.2133 277.186 57.768C277.741 58.28 278.061 59.0907 278.146 60.2C278.231 61.2667 277.975 62.1413 277.378 62.824C276.823 63.464 275.97 63.848 274.818 63.976L273.41 64.104C270.807 64.36 268.845 65.1707 267.522 66.536C266.199 67.8587 265.538 69.736 265.538 72.168V85.416C265.538 86.7387 265.197 87.7627 264.514 88.488C263.831 89.1707 262.829 89.512 261.506 89.512ZM297.397 89.64C293.855 89.64 290.805 88.9787 288.245 87.656C285.685 86.3333 283.701 84.456 282.293 82.024C280.927 79.592 280.245 76.712 280.245 73.384C280.245 70.1413 280.906 67.304 282.229 64.872C283.594 62.44 285.45 60.5413 287.797 59.176C290.186 57.768 292.895 57.064 295.925 57.064C298.143 57.064 300.127 57.4267 301.877 58.152C303.669 58.8773 305.183 59.9227 306.421 61.288C307.701 62.6533 308.661 64.3173 309.301 66.28C309.983 68.2 310.325 70.376 310.325 72.808C310.325 73.576 310.047 74.1733 309.493 74.6C308.981 74.984 308.234 75.176 307.253 75.176H286.709V70.568H304.693L303.669 71.528C303.669 69.5653 303.37 67.9227 302.773 66.6C302.218 65.2773 301.386 64.2747 300.277 63.592C299.21 62.8667 297.866 62.504 296.245 62.504C294.453 62.504 292.917 62.9307 291.637 63.784C290.399 64.5947 289.439 65.768 288.757 67.304C288.117 68.7973 287.797 70.5893 287.797 72.68V73.128C287.797 76.6267 288.607 79.2507 290.229 81C291.893 82.7067 294.325 83.56 297.525 83.56C298.634 83.56 299.871 83.432 301.237 83.176C302.645 82.8773 303.967 82.3867 305.205 81.704C306.101 81.192 306.89 80.9787 307.573 81.064C308.255 81.1067 308.789 81.3413 309.173 81.768C309.599 82.1947 309.855 82.728 309.941 83.368C310.026 83.9653 309.898 84.584 309.557 85.224C309.258 85.864 308.725 86.4187 307.957 86.888C306.463 87.8267 304.735 88.5307 302.773 89C300.853 89.4267 299.061 89.64 297.397 89.64Z" fill="#FEF3E2"/>
                        <path d="M160.918 89.64C159.04 89.64 157.163 89.4907 155.286 89.192C153.408 88.936 151.638 88.5307 149.974 87.976C148.31 87.3787 146.816 86.6533 145.494 85.8C144.726 85.288 144.192 84.6693 143.894 83.944C143.595 83.2187 143.488 82.5147 143.574 81.832C143.702 81.1067 143.979 80.488 144.406 79.976C144.875 79.4213 145.451 79.08 146.134 78.952C146.816 78.824 147.563 79.016 148.374 79.528C150.251 80.6373 152.235 81.448 154.326 81.96C156.416 82.472 158.614 82.728 160.918 82.728C164.288 82.728 166.742 82.1733 168.278 81.064C169.814 79.912 170.582 78.44 170.582 76.648C170.582 75.1547 170.027 73.9813 168.918 73.128C167.851 72.2747 165.995 71.5707 163.35 71.016L156.31 69.544C152.256 68.6907 149.227 67.2613 147.222 65.256C145.259 63.208 144.278 60.52 144.278 57.192C144.278 55.1013 144.704 53.2027 145.558 51.496C146.411 49.7893 147.606 48.3173 149.142 47.08C150.72 45.8427 152.576 44.904 154.71 44.264C156.886 43.5813 159.275 43.24 161.878 43.24C164.438 43.24 166.87 43.56 169.174 44.2C171.478 44.84 173.547 45.7787 175.382 47.016C176.064 47.4853 176.512 48.0613 176.726 48.744C176.982 49.4267 177.046 50.1093 176.918 50.792C176.79 51.432 176.491 51.9867 176.022 52.456C175.552 52.9253 174.955 53.2027 174.229 53.288C173.547 53.3733 172.758 53.16 171.862 52.648C170.283 51.752 168.683 51.112 167.062 50.728C165.44 50.344 163.691 50.152 161.814 50.152C159.851 50.152 158.166 50.4293 156.758 50.984C155.35 51.5387 154.262 52.328 153.494 53.352C152.768 54.3333 152.406 55.5067 152.406 56.872C152.406 58.408 152.918 59.6453 153.942 60.584C154.966 61.48 156.715 62.184 159.19 62.696L166.166 64.168C170.39 65.064 173.526 66.472 175.574 68.392C177.664 70.312 178.71 72.872 178.71 76.072C178.71 78.12 178.283 79.976 177.43 81.64C176.619 83.304 175.424 84.7333 173.846 85.928C172.31 87.1227 170.454 88.04 168.278 88.68C166.102 89.32 163.648 89.64 160.918 89.64Z" fill="#FC4A1A"/>
                        <path d="M121 95L127.487 111.06L138.152 97.4122L121 95ZM201.861 93.9307L200.801 92.8701C182.009 111.661 153.64 114.761 132.411 102.028L131.639 103.314L130.867 104.6C153.292 118.051 183.17 114.744 202.922 94.9914L201.861 93.9307Z" fill="#FEF3E2"/>
                        <path d="M201.861 39.8961L195.375 23.8361L184.71 37.4838L201.861 39.8961ZM121 40.9654L122.061 42.026C140.852 23.2347 169.222 20.1352 190.451 32.8686L191.222 31.5822L191.994 30.2959C169.569 16.8455 139.691 20.1525 119.939 39.9047L121 40.9654Z" fill="#FEF3E2"/>
                        <path d="M163 48V40" stroke="#FC4A1A" stroke-width="5"/>
                        <path d="M160 93.5V88" stroke="#FC4A1A" stroke-width="5"/>
                    </svg>
                </div>

                {/* Navigation buttons */}
                <div className="flex gap-3 items-center">
                    <motion.button
                        className="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 flex items-center gap-2"
                        style={{ 
                            color: isActive('/rides') ? 'var(--color-primary)' : '#4a5568',
                            backgroundColor: isActive('/rides') ? 'rgba(var(--color-primary-rgb), 0.15)' : 'transparent',
                            borderBottom: isActive('/rides') ? '2px solid var(--color-primary)' : '2px solid transparent'
                        }}
                        whileHover={{ scale: 1.05 }}
                        whileTap={{ scale: 0.95 }}
                        onClick={() => navigate("/rides")}
                    >
                        <Car size={18} />
                        Ride Post & Request
                    </motion.button>
                    <motion.button
                        className="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 flex items-center gap-2"
                        style={{ 
                            color: isActive('/ridesearch') ? 'var(--color-primary)' : '#4a5568',
                            backgroundColor: isActive('/ridesearch') ? 'rgba(var(--color-primary-rgb), 0.15)' : 'transparent',
                            borderBottom: isActive('/ridesearch') ? '2px solid var(--color-primary)' : '2px solid transparent'
                        }}
                        whileHover={{ scale: 1.05 }}
                        whileTap={{ scale: 0.95 }}
                        onClick={() => navigate("/ridesearch")}
                    >
                        <Search size={18} />
                        Ride Search
                    </motion.button>

                    {/* Conditional rendering: Show avatar if logged in, otherwise show login button */}
                    {isAuthenticated ? (
                        <div className="relative" ref={dropdownRef} style={{ zIndex: 1001 }}>
                            {/* Avatar button */}
                            <motion.button
                                onClick={() => setShowDropdown(!showDropdown)}
                                className="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold transition-all duration-200 hover:shadow-lg"
                                style={{ backgroundColor: 'var(--color-primary)' }}
                                whileHover={{ scale: 1.1 }}
                                whileTap={{ scale: 0.95 }}
                                aria-label="User menu"
                            >
                                {getUserInitials()}
                            </motion.button>

                            {/* Dropdown menu */}
                            <AnimatePresence>
                                {showDropdown && (
                                    <motion.div 
                                        className="absolute right-0 mt-2 w-48 rounded-lg shadow-lg py-2"
                                        style={{ border: '1px solid var(--color-secondary)', backgroundColor: 'rgba(255, 255, 255, 0.75)', backdropFilter: 'blur(8px)', zIndex: 9999 }}
                                        initial={{ opacity: 0, y: -10, scale: 0.95 }}
                                        animate={{ opacity: 1, y: 0, scale: 1 }}
                                        exit={{ opacity: 0, y: -10, scale: 0.95 }}
                                        transition={{ duration: 0.2 }}
                                    >
                                        {/* User info */}
                                        <div className="px-4 py-2 border-b" style={{ borderBottomColor: 'var(--color-secondary)' }}>
                                            <p className="font-semibold text-sm truncate" style={{ color: 'var(--color-primary)' }}>
                                                {user?.full_name || 'User'}
                                            </p>
                                            <p className="text-xs text-gray-500 truncate">
                                                {user?.email}
                                            </p>
                                        </div>

                                        {/* Menu items */}
                                        <motion.button
                                            onClick={() => {
                                                setShowDropdown(false);
                                                navigate("/dashboard");
                                            }}
                                            className="w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2"
                                            style={{ color: '#4a5568' }}
                                            whileHover={{ 
                                                backgroundColor: 'rgba(var(--color-primary-rgb), 0.1)',
                                                color: 'var(--color-primary)'
                                            }}
                                        >
                                            <BarChart3 size={16} />
                                            Dashboard
                                        </motion.button>

                                        <motion.button
                                            onClick={() => user?.role === "admin" && (() => {
                                                setShowDropdown(false);
                                                navigate("/admin");
                                            })()}
                                            className="w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2"
                                            style={{ color: '#4a5568' }}
                                            whileHover={{ 
                                                backgroundColor: 'rgba(var(--color-primary-rgb), 0.1)',
                                                color: 'var(--color-primary)'
                                            }}
                                        >
                                            <Shield size={16} />
                                            Admin Dashboard
                                        </motion.button>

                                        <motion.button
                                            onClick={() => {
                                                setShowDropdown(false);
                                                navigate("/settings");
                                            }}
                                            className="w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2"
                                            style={{ color: '#4a5568' }}
                                            whileHover={{ 
                                                backgroundColor: 'rgba(var(--color-primary-rgb), 0.1)',
                                                color: 'var(--color-primary)'
                                            }}
                                        >
                                            <Settings size={16} />
                                            Settings
                                        </motion.button>

                                        <motion.button
                                            onClick={handleLogout}
                                            className="w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2"
                                            style={{ color: '#4a5568' }}
                                            whileHover={{ 
                                                backgroundColor: 'rgba(var(--color-primary-rgb), 0.1)',
                                                color: 'var(--color-primary)'
                                            }}
                                        >
                                            <LogOut size={16} />
                                            Logout
                                        </motion.button>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    ) : (
                        <motion.button
                            className="px-6 py-2.5 rounded-lg text-white font-semibold transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
                            style={{ backgroundColor: 'var(--color-primary)' }}
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                            onClick={() => navigate("/signin")}
                        >
                            Login / Sign Up
                        </motion.button>
                    )}
                </div>
            </div>
        </header>
    );
};

export default Header;
